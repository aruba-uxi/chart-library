{{- range $name, $data := .Values.cronjobs }}
{{- $overrideImage := default dict $data.image }}
{{- $datadog := default dict $data.datadog }}
{{- $envBasic := deepCopy (default dict $.Values.global.env) | mustMerge (default dict $data.env) }}
{{- $envFields := deepCopy (default dict $.Values.global.envFields) | mustMerge (default dict $data.envFields) }}
{{- $envSealedSecrets := deepCopy (default dict $.Values.global.envSealedSecrets) | mustMerge (default dict $data.envSealedSecrets) }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $name }}
  labels:
    {{- include "application.labels" (dict "context" $ "name" $name) | nindent 4 }}
spec:
  schedule: {{ $data.schedule | quote}}
  jobTemplate:
    spec:
      template:
        spec:
          {{- if $.Values.global.sealedImagePullSecret }}
          imagePullSecrets:
          - name: {{ include "sealedImagePullSecret.name" "" }}
          {{- end }}
          {{- if $data.serviceAccount }}
          serviceAccountName: {{ template "serviceAccount.name" (dict "name" $name "data" $data) }}
          {{- end }}
          containers:
          - name: {{ $name }}
            image: "{{ default $.Values.global.image.repository $overrideImage.repository }}:{{ default $.Values.global.image.tag $overrideImage.tag }}"
            imagePullPolicy: {{ default $.Values.global.image.pullPolicy $overrideImage.pullPolicy }}
            env:
            - name: ENVIRONMENT
              value: {{ include "global.environment" (dict "environment" $.Values.global.environment) }}
            - name: DD_ENABLED
              value: {{ default false $datadog.enabled }}
            {{- if $datadog.enabled }}
            - name: DD_ENV
              value: {{ include "global.environment" (dict "environment" $.Values.global.environment) }}
            - name: DD_SERVICE
              value: {{ $name }}
            - name: DD_AGENT_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: DD_ENTITY_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            {{- end }}
            {{- if or $envBasic $envFields $envSealedSecrets }}
            {{- include "application.env-variables" (dict "data" $envBasic) | indent 12 }}
            {{- include "application.env-fields" (dict "data" $envFields) | indent 12 }}
            {{- include "application.env-sealed-secrets" (dict "name" $name "data" $envSealedSecrets) | indent 12 }}
            {{- end }}
            {{- with $data.command }}
            command: {{ toRawJson . }}
            {{- end }}
          restartPolicy: {{ default "OnFailure" $data.restartPolicy }}
{{- end }}
